@using ASI.Basecode.Services.ServiceModels
@model IEnumerable<UserViewModel>

<div class="container mt-4">
    <h2>User Management</h2>
    <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#createUserModal">
        Create New User
    </button>

    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Team</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Model)
            {
                <tr>
                    <td>@($"{user.Fname} {user.Lname}")</td>
                    <td>@user.Email</td>
                    <td>@user.Role</td>
                    <td>@user.TeamName</td>
                    <td>@(user.IsActive == true ? "Active" : "Inactive")</td>
                    <td>
                        <a asp-action="ViewUser" asp-route-id="@user.UserId" class="btn btn-info btn-sm">View</a>
                        <button class="btn btn-warning btn-sm" onclick="editUser(@user.UserId)">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(@user.UserId)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New User</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="createUserForm" asp-action="CreateUser" method="post">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="Fname">First Name</label>
                        <input name="Fname" id="Fname" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label for="Lname">Last Name</label>
                        <input name="Lname" id="Lname" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label for="Email">Email</label>
                        <input name="Email" id="Email" type="email" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label for="Password">Password</label>
                        <input name="Password" id="Password" type="password" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label for="ConfirmPassword">Confirm Password</label>
                        <input name="ConfirmPassword" id="ConfirmPassword" type="password" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label for="Role">Role</label>
                        <select name="Role" id="Role" class="form-control" required>
                            @if (User.HasClaim(c => c.Type == System.Security.Claims.ClaimTypes.Role && 
                                c.Value.Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase)))
                            {
                                <option value="Admin">Admin</option>
                            }
                            @if (User.HasClaim(c => c.Type == System.Security.Claims.ClaimTypes.Role && 
                                (c.Value.Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase) || 
                                 c.Value.Equals("Admin", StringComparison.OrdinalIgnoreCase))))
                            {
                                <option value="Agent">Agent</option>
                            }
                            <option value="User">User</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="editUserForm" asp-action="EditUser" method="post">
                <input type="hidden" id="editUserId" name="UserId" />
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editFname">First Name</label>
                        <input name="Fname" id="editFname" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label for="editLname">Last Name</label>
                        <input name="Lname" id="editLname" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input name="Email" id="editEmail" type="email" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label for="editPassword">Password</label>
                        <input name="Password" id="editPassword" type="password" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="editConfirmPassword">Confirm Password</label>
                        <input name="ConfirmPassword" id="editConfirmPassword" type="password" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="editRole">Role</label>
                        <select name="Role" id="editRole" class="form-control" required>
                            @if (User.HasClaim(c => c.Type == System.Security.Claims.ClaimTypes.Role && 
                                c.Value.Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase)))
                            {
                                <option value="Admin">Admin</option>
                            }
                            @if (User.HasClaim(c => c.Type == System.Security.Claims.ClaimTypes.Role && 
                                (c.Value.Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase) || 
                                 c.Value.Equals("Admin", StringComparison.OrdinalIgnoreCase))))
                            {
                                <option value="Agent">Agent</option>
                            }
                            <option value="User">User</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Move deleteUser function to global scope
        function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                console.log('Current user claims:', document.cookie);
                
                $.ajax({
                    url: '/Account/DeleteUser/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            console.log('Error details:', response);
                            toastr.error(response.message || 'Failed to delete user');
                        }
                    },
                    error: function(xhr) {
                        console.log('Error details:', xhr);
                        toastr.error('An error occurred while deleting the user');
                    }
                });
            }
        }
function editUser(id) {
            $.get('/Account/GetUserDetails/' + id, function(user) {
                $('#editUserId').val(user.userId);
                $('#editFname').val(user.fname);
                $('#editLname').val(user.lname);
                $('#editEmail').val(user.email);
                $('#editRole').val(user.role);
                $('#editUserModal').modal('show');
            }).fail(function() {
                toastr.error('Failed to load user details');
            });
        }

        $(document).ready(function() {
            $('#editUserForm').validate({
                rules: {
                    Fname: "required",
                    Lname: "required",
                    Email: {
                        required: true,
                        email: true
                    },
                    Password: {
                        required: false,
                        minlength: 6
                    },
                    ConfirmPassword: {
                        required: false,
                        equalTo: "#editPassword"
                    },
                    Role: "required"
                },
                messages: {
                    Password: {
                        minlength: "Password must be at least 6 characters"
                    },
                    ConfirmPassword: {
                        equalTo: "Passwords do not match"
                    }
                },
                submitHandler: function(form) {
                    $.ajax({
                        url: form.action,
                        type: 'POST',
                        data: $(form).serialize(),
                        success: function(response) {
                            if (response.success) {
                                $('#editUserModal').modal('hide');
                                location.reload();
                            } else {
                                toastr.error(response.message || 'Failed to update user');
                            }
                        },
                        error: function(xhr) {
                            toastr.error(xhr.responseJSON?.message || 'An error occurred while updating the user');
                        }
                    });
                    return false;
                }
            });

            // Existing deleteUser function and createUserForm validation...
        });
        $(document).ready(function() {
            $('#createUserForm').validate({
                rules: {
                    Fname: "required",
                    Lname: "required",
                    Email: {
                        required: true,
                        email: true
                    },
                    Password: {
                        required: true,
                        minlength: 6
                    },
                    ConfirmPassword: {
                        required: true,
                        equalTo: "#Password"
                    },
                    Role: "required"
                },
                messages: {
                    ConfirmPassword: {
                        equalTo: "Passwords do not match"
                    }
                },
                submitHandler: function(form) {
                    $.ajax({
                        url: form.action,
                        type: 'POST',
                        data: $(form).serialize(),
                        success: function(response) {
                            if (response.success) {
                                $('#createUserModal').modal('hide');
                                location.reload();
                            } else {
                                toastr.error(response.message || 'Failed to create user');
                            }
                        },
                        error: function(xhr) {
                            toastr.error(xhr.responseJSON?.message || 'An error occurred while creating the user');
                        }
                    });
                    return false;
                }
            });
        });
    </script>
} 