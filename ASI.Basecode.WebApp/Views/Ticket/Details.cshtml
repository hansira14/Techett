@using Microsoft.AspNetCore.Mvc.TagHelpers
@model ASI.Basecode.Services.ServiceModels.TicketViewModel
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://unpkg.com/flowbite@1.4.7/dist/flowbite.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://unpkg.com/flowbite@1.4.7/dist/flowbite.js"></script>


<div class="grid grid-cols-1 gap-6 mb-6 h-screen w-full overflow-hidden">
    <div class="h-full border border-[#7E8EF1] border-opacity-100 p-6 shadow-md shadow-#7E8EF1/5 rounded-[15px]">
        <div class="container mt-4">
            <div class="row">
                <!-- Left side - Comments -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h4>Comments</h4>
                        </div>
                        <div class="card-body">
                            <div id="commentsList" class="comments-list" style="max-height: 600px; overflow-y: auto;">
                                <!-- Comments will be loaded here -->
                            </div>
                            <div class="mt-3">
                                <form id="addCommentForm">
                                    <input type="hidden" name="TicketId" value="@Model.TicketId" />
                                    <div class="form-group">
                                        <textarea name="Comment" class="form-control" rows="3" placeholder="Add a comment..." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-2">Add Comment</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right side - Ticket Details -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3>@Model.Title</h3>
                            <div>
                                @if (Model.Status != "Resolved")
                                {
                                    <button class="btn btn-success" onclick="markAsResolved()">Mark as Resolved</button>
                                    <button class="btn btn-primary" onclick="editMode()">Edit</button>
                                }
                                <a href="/Ticket" class="btn btn-secondary">Back to List</a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="viewMode">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Status:</strong> @Model.Status</p>
                                        <p><strong>Priority:</strong> @Model.Priority</p>
                                        <p><strong>Category:</strong> @Model.Category</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Created On:</strong> @Model.CreatedOn.ToString("g")</p>
                                        <p><strong>Created By:</strong> @Model.CreatedByName</p>
                                        @if (Model.ResolvedOn.HasValue)
                                        {
                                            <p><strong>Resolved On:</strong> @Model.ResolvedOn.Value.ToString("g")</p>
                                        }
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h5>Description</h5>
                                    <p>@Model.Content</p>
                                </div>
                            </div>

                            <div id="editMode" style="display: none;">
                                <form id="editTicketForm">
                                    <input type="hidden" name="TicketId" value="@Model.TicketId" />
                                    <div class="form-group">
                                        <label for="Title">Title</label>
                                        <input name="Title" id="Title" class="form-control" value="@Model.Title" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="Content">Description</label>
                                        <textarea name="Content" id="Content" class="form-control" rows="4" required>@Model.Content</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="Category">Category</label>
                                        <select name="Category" id="Category" class="form-control" required>
                                            <option value="Bug" selected="@(Model.Category == "Bug")">Bug</option>
                                            <option value="Feature" selected="@(Model.Category == "Feature")">Feature Request</option>
                                            <option value="Support" selected="@(Model.Category == "Support")">Support</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="Priority">Priority</label>
                                        <select name="Priority" id="Priority" class="form-control" required>
                                            <option value="1" selected="@(Model.Priority == 1)">Low</option>
                                            <option value="2" selected="@(Model.Priority == 2)">Medium</option>
                                            <option value="3" selected="@(Model.Priority == 3)">High</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="Status">Status</label>
                                        <select name="Status" id="Status" class="form-control" required>
                                            <option value="Open" selected="@(Model.Status == "Open")">Open</option>
                                            <option value="In Progress" selected="@(Model.Status == "In Progress")">In Progress</option>
                                            <option value="Resolved" selected="@(Model.Status == "Resolved")">Resolved</option>
                                        </select>
                                    </div>
                                    <div class="mt-3">
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Updates History -->
        <div class="card mt-4">
            <div class="card-header">
                <h4>Update History</h4>
            </div>
            <div class="card-body">
                <div id="updatesList">
                    <!-- Updates will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Attachments -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Attachments</h4>
                @if (Model.Status != "Resolved")
                {
                    <div>
                        <input type="file" id="attachmentInput" class="d-none" multiple />
                        <button class="btn btn-primary btn-sm" onclick="$('#attachmentInput').click()">
                            <i class="fas fa-plus"></i> Add Attachments
                        </button>
                    </div>
                }
            </div>
            <div class="card-body">
                <div id="attachmentsList">
                    <!-- Attachments will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function editMode() {
            $('#viewMode').hide();
            $('#editMode').show();
        }

        function cancelEdit() {
            $('#editMode').hide();
            $('#viewMode').show();
        }

        $('#editTicketForm').submit(function(e) {
            e.preventDefault();
            var oldStatus = '@Model.Status';
            var oldPriority = '@Model.Priority';
            var newStatus = $('#Status').val();
            var newPriority = $('#Priority').val();
            
            
            $.ajax({
                url: '/Ticket/EditTicket',
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    if (response.success) {
                        if (oldStatus !== newStatus || oldPriority !== newPriority) {
                            loadUpdates();
                        }
                        location.reload();
                    } else {
                        toastr.error(response.message || 'Failed to update ticket');
                    }
                },
                error: function() {
                    toastr.error('An error occurred while updating the ticket');
                }
            });
        });

        function loadComments() {
            $.get('/Comment/GetTicketComments', { ticketId: @Model.TicketId }, function(comments) {
                var html = '';
                comments.forEach(function(comment) {
                    html += `
                        <div class="comment-item mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${comment.userName}</strong>
                                    <small class="text-muted ml-2">${new Date(comment.commentedOn).toLocaleString()}</small>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="deleteComment(${comment.commentId})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <p class="mb-0 mt-2">${comment.comment}</p>
                            <hr>
                        </div>
                    `;
                });
                $('#commentsList').html(html);
                // Scroll to bottom of comments list after loading
                var commentsList = document.getElementById('commentsList');
                commentsList.scrollTop = commentsList.scrollHeight;
            });
        }

        $(document).ready(function() {
            loadComments();

            $('#addCommentForm').submit(function(e) {
                e.preventDefault();
                $.ajax({
                    url: '/Comment/AddComment',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.success) {
                            loadComments();
                            $('textarea[name="Comment"]').val('');
                        } else {
                            toastr.error(response.message || 'Failed to add comment');
                        }
                    },
                    error: function() {
                        toastr.error('An error occurred while adding the comment');
                    }
                });
            });

            loadUpdates();

            loadAttachments();

            $('#attachmentInput').change(function(e) {
                if ('@Model.Status' === 'Resolved') {
                    toastr.error('Cannot add attachments to resolved tickets');
                    $(this).val('');
                    return;
                }
                
                const files = e.target.files;
                if (files.length > 0) {
                    const formData = new FormData();
                    formData.append('ticketId', @Model.TicketId);
                    
                    for (let i = 0; i < files.length; i++) {
                        formData.append('file', files[i]);
                    }

                    $.ajax({
                        url: '/Attachment/Upload',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                loadAttachments();
                                $(this).val('');
                            } else {
                                toastr.error(response.message || 'Failed to upload attachment');
                            }
                        },
                        error: function() {
                            toastr.error('An error occurred while uploading the attachment');
                        }
                    });
                }
            });
        });

        function deleteComment(commentId) {
            if (confirm('Are you sure you want to delete this comment?')) {
                $.ajax({
                    url: '/Comment/DeleteComment',
                    type: 'POST',
                    data: { commentId: commentId },
                    success: function(response) {
                        if (response.success) {
                            loadComments();
                        } else {
                            toastr.error(response.message || 'Failed to delete comment');
                        }
                    },
                    error: function() {
                        toastr.error('An error occurred while deleting the comment');
                    }
                });
            }
        }

        function loadUpdates() {
            $.get('/Update/GetTicketUpdates', { ticketId: @Model.TicketId }, function(updates) {
                var html = '';
                updates.forEach(function(update) {
                    html += `
                        <div class="update-item mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${update.updatedByName}</strong>
                                    <small class="text-muted ml-2">${new Date(update.updatedOn).toLocaleString()}</small>
                                </div>
                            </div>
                            <p class="mb-0 mt-2">${update.message}</p>
                            <div class="mt-1">
                                ${update.status ? `<small class="text-muted">Status: ${update.status}</small>` : ''}
                                ${update.priority ? `<small class="text-muted ml-2">Priority: ${update.priority}</small>` : ''}
                            </div>
                            <hr>
                        </div>
                    `;
                });
                $('#updatesList').html(html);
            });
        }

        function loadAttachments() {
            $.get('/Attachment/GetTicketAttachments', { ticketId: @Model.TicketId }, function(attachments) {
                var html = '';
                attachments.forEach(function(attachment) {
                    const isImage = attachment.filetype.startsWith('image/');
                    
                    html += `
                        <div class="attachment-item mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    ${isImage ? 
                                        `<div class="mr-3">
                                            <img src="${attachment.source}" alt="${attachment.filename}" 
                                                 style="max-width: 150px; max-height: 150px; object-fit: contain;" 
                                                 class="img-thumbnail"/>
                                        </div>` : 
                                        `<i class="fas fa-paperclip mr-2"></i>`
                                    }
                                    <div>
                                        <a href="${attachment.source}" target="_blank" class="text-decoration-none">
                                            ${attachment.filename}
                                        </a>
                                        <small class="text-muted d-block">${formatFileSize(attachment.filesize)}</small>
                                    </div>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="deleteAttachment(${attachment.attachmentId})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                $('#attachmentsList').html(html || '<p>No attachments</p>');
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function deleteAttachment(attachmentId) {
            if ('@Model.Status' === 'Resolved') {
                toastr.error('Cannot delete attachments for resolved tickets');
                return;
            }
            
            if (confirm('Are you sure you want to delete this attachment?')) {
                $.ajax({
                    url: '/Attachment/Delete',
                    type: 'POST',
                    data: { attachmentId: attachmentId },
                    success: function(response) {
                        if (response.success) {
                            loadAttachments();
                        } else {
                            toastr.error(response.message || 'Failed to delete attachment');
                        }
                    },
                    error: function() {
                        toastr.error('An error occurred while deleting the attachment');
                    }
                });
            }
        }

        function markAsResolved() {
            if (confirm('Are you sure you want to mark this ticket as resolved?')) {
                $.ajax({
                    url: '/Ticket/EditTicket',
                    type: 'POST',
                    data: {
                        TicketId: @Model.TicketId,
                        Title: '@Model.Title',
                        Content: '@Model.Content',
                        Category: '@Model.Category',
                        Priority: '@Model.Priority',
                        Status: 'Resolved'
                    },
                    success: function(response) {
                        if (response.success) {
                            loadUpdates();
                            location.reload();
                        } else {
                            toastr.error(response.message || 'Failed to resolve ticket');
                        }
                    },
                    error: function() {
                        toastr.error('An error occurred while resolving the ticket');
                    }
                });
            }
        }
    </script>
}

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            transition: background-color 0.4s ease;
        }
    </style>